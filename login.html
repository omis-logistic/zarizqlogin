<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Login - ZA RIZQ ENTERPRISE</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    /* Mobile-first styles */
    .login-page {
      width: 100%;
      padding: 1rem;
      animation: fadeIn 0.3s ease-in;
    }

    h1.login-header {
      font-size: 2.5rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 2rem;
      color: var(--gold);
      padding: 1rem;
      border-bottom: 3px solid var(--gold);
    }

    .login-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      width: 100%;
      margin: 0 auto;
      box-shadow: 0 0 15px rgba(197, 160, 71, 0.3);
    }

    /* Desktop overrides */
    body.desktop-view .login-container {
      max-width: 400px;
      padding: 2rem;
      margin: 2rem auto;
    }

    input {
      background: #333;
      border: 1px solid var(--gold);
      color: var(--text-light);
      font-size: 16px;
      margin: 1rem 0;
      width: 100%;
      padding: 12px;
      border-radius: 5px;
      transition: border-color 0.3s ease;
    }

    button {
      width: 100%;
      padding: 12px;
      margin: 0.5rem 0;
      font-size: 16px;
      min-height: 44px;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .auth-links {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .secondary-btn {
      background: transparent !important;
      border: 1px solid var(--gold) !important;
      color: var(--gold) !important;
    }

    .secondary-btn:hover {
      background: var(--gold) !important;
      color: var(--dark-bg) !important;
    }

    /* Loading spinner styles */
    .button-loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--gold);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: none; /* Hidden by default */
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      h1.login-header {
        font-size: 1.8rem;
        padding: 0.5rem;
      }
      
      body.mobile-view .login-container {
        padding: 1rem;
      }
      
      input {
        font-size: 16px;
        padding: 12px;
      }
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="login-page">
    <h1 class="login-header">ZA RIZQ ENTERPRISE</h1>
    
    <div class="login-container">
      <div class="input-group">
        <input type="tel" 
               id="phone" 
               placeholder="Phone Number"
               pattern="^(673\d{7,}|60\d{9,})$" 
               required>
      </div>
      
      <div class="input-group">
        <input type="password" 
               id="password" 
               placeholder="Password" 
               required>
      </div>
      <div id="loginError" class="inline-error" style="display: none;"></div>
      <button onclick="handleLogin()" id="loginBtn">
        <div class="button-loader" id="loginSpinner"></div>
        <span id="loginText">LOGIN</span>
      </button>
      
      <div class="auth-links">
        <button onclick="showRegistration()">CREATE ACCOUNT</button>
        <button class="secondary-btn" onclick="showForgotPassword()">
          FORGOT PASSWORD?
        </button>
      </div>
    </div>
  </div>

  <!-- Error message container -->
  <div id="error-message" class="error-message" style="display: none;"></div>

  <script src="scripts/app.js"></script>
  <script>
    // ================= TRACKING PARAMETER HANDLING =================
    // Check if user is already logged in and handle tracking parameter
    document.addEventListener('DOMContentLoaded', function() {
      const userData = checkSession();
      const urlParams = new URLSearchParams(window.location.search);
      const tracking = urlParams.get('tracking');
      
      console.log('Page loaded, user logged in:', !!userData, 'tracking:', tracking);
      
      if (userData && tracking) {
        // User is already logged in and there's a tracking parameter
        console.log('User already logged in, redirecting to parcel declaration');
        sessionStorage.setItem('prefillTracking', tracking);
        
        // Clean the URL and redirect
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);
        
        // Use setTimeout to avoid redirect loop
        setTimeout(() => {
          safeRedirect('parcel-declaration.html');
        }, 100);
        return;
      }
      
      if (tracking) {
        // Store tracking for post-login redirect (bypass modal)
        console.log('Storing tracking for post-login:', tracking);
        sessionStorage.setItem('pendingTracking', tracking);
        sessionStorage.setItem('pendingRedirect', 'parcel-declaration.html');
        
        // Clean the URL immediately
        const cleanUrl = window.location.pathname;
        window.history.replaceState({}, '', cleanUrl);
      }
    });
  
    // ================= EXACT Mark 1 login implementation =================
    function handleLogin() {
      const btn = document.getElementById('loginBtn');
      const spinner = document.getElementById('loginSpinner');
      const loginText = document.getElementById('loginText');
      
      // Save original text and disable button
      const originalText = loginText.textContent;
      btn.disabled = true;
      
      // Show spinner and change text
      spinner.style.display = 'inline-block';
      loginText.textContent = 'Processing...';
  
      const phone = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;
  
      if (!validatePhone(phone)) {
        showError('Invalid phone number format');
        resetLoginButton(btn, spinner, loginText, originalText);
        return;
      }
  
      const callbackName = `jsonp_${Date.now()}`;
      const script = document.createElement('script');
      
      // EXACTLY like Mark 1 - with crossorigin attribute
      script.crossOrigin = 'anonymous';
      script.src = `${CONFIG.GAS_URL}?action=processLogin&phone=${encodeURIComponent(phone)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
  
      window[callbackName] = (response) => {
        // Restore button state
        resetLoginButton(btn, spinner, loginText, originalText);
  
        if (response.success) {
          console.log('Login successful, TempPassword flag:', response.tempPassword);
          sessionStorage.setItem('userData', JSON.stringify({
            phone: response.phone,
            email: response.email,
            tempPassword: response.tempPassword
          }));
          localStorage.setItem('lastActivity', Date.now());
          
          // Check for pending tracking redirect
          const pendingTracking = sessionStorage.getItem('pendingTracking');
          const pendingRedirect = sessionStorage.getItem('pendingRedirect');
          
          console.log('Pending tracking after login:', pendingTracking);
          console.log('Pending redirect after login:', pendingRedirect);
          
          if (response.tempPassword) {
            // Still need to reset password first
            console.log('Temp password detected, redirecting to password reset');
            setTimeout(() => {
              window.location.href = 'password-reset.html?force=true';
            }, 100);
          } else if (pendingTracking && pendingRedirect === 'parcel-declaration.html') {
            // Clear pending tracking and redirect directly to parcel declaration
            console.log('Redirecting to parcel declaration with tracking:', pendingTracking);
            sessionStorage.removeItem('pendingTracking');
            sessionStorage.removeItem('pendingRedirect');
            sessionStorage.setItem('prefillTracking', pendingTracking);
            setTimeout(() => {
              window.location.href = 'parcel-declaration.html';
            }, 100);
          } else {
            // Normal login flow - go to dashboard
            console.log('Normal login flow, going to dashboard');
            localStorage.setItem('freshLogin', 'true');
            sessionStorage.setItem('modalShown', 'false');
            setTimeout(() => {
              window.location.href = 'dashboard.html?fresh=1';
            }, 100);
          }
        } else {
          document.getElementById('password').value = '';
          showError(response.message || 'Authentication failed');
        }
        
        // Cleanup - EXACTLY like Mark 1
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
      };
      
      // Add error handler
      script.onerror = function() {
        resetLoginButton(btn, spinner, loginText, originalText);
        showError('Network error. Please try again.');
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
      };
      
      document.body.appendChild(script);
    }
  
    // ================= HELPER FUNCTIONS =================
    function resetLoginButton(btn, spinner, textElement, originalText) {
      btn.disabled = false;
      spinner.style.display = 'none';
      textElement.textContent = originalText;
    }
  
    // ======== EXACT Mark 1 ENTER KEY HANDLING ========
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });
  
    document.getElementById('phone').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password').focus();
      }
    });
    
    function showRegistration() {
      safeRedirect('register.html');
    }
  
    function showForgotPassword() {
      safeRedirect('forgot-password.html');
    }
  
    // EXACT Mark 1 validation function
    function validatePhone(phone) {
      const regex = /^(673\d{7,}|60\d{9,})$/;
      return regex.test(phone);
    }
  
    // EXACT Mark 1 error display
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }
  
    // EXACT Mark 1 redirect function - Fixed to prevent loops
    function safeRedirect(path) {
      try {
        // Extract base path without query parameters
        const basePath = path.split('?')[0].split('#')[0];
        
        const allowedPaths = [
          'login.html', 'register.html', 'dashboard.html',
          'forgot-password.html', 'password-reset.html',
          'my-info.html', 'parcel-declaration.html', 'track-parcel.html',
          'billing-info.html', 'invoice.html'
        ];
        
        if (!allowedPaths.includes(basePath)) {
          throw new Error('Unauthorized path');
        }
        
        // Prevent redirect loops by checking current path
        const currentPath = window.location.pathname.split('/').pop();
        if (currentPath === basePath) {
          console.log('Already on target page, skipping redirect');
          return;
        }
        
        // Use timeout to avoid immediate redirect loops
        setTimeout(() => {
          window.location.href = path;
        }, 50);
      } catch (error) {
        console.error('Redirect error:', error);
        showError('Navigation failed. Please try again.');
      }
    }
  </script>
</body>
</html>
