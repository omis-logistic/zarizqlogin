<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <title>Login - ZA RIZQ Enterprise</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    /* Mobile-first styles */
    .login-page {
      width: 100%;
      padding: 1rem;
      animation: fadeIn 0.3s ease-in;
    }

    h1.login-header {
      font-size: 2.5rem;
      text-align: center;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 2rem;
      color: var(--gold);
      padding: 1rem;
      border-bottom: 3px solid var(--gold);
    }

    .login-container {
      background: rgba(0, 0, 0, 0.7);
      padding: 1.5rem;
      border-radius: 10px;
      width: 100%;
      margin: 0 auto;
      box-shadow: 0 0 15px rgba(197, 160, 71, 0.3);
    }

    /* Desktop overrides */
    body.desktop-view .login-container {
      max-width: 400px;
      padding: 2rem;
      margin: 2rem auto;
    }

    input {
      background: #333;
      border: 1px solid var(--gold);
      color: var(--text-light);
      font-size: 16px;
      margin: 1rem 0;
      width: 100%;
      padding: 12px;
      border-radius: 5px;
      transition: border-color 0.3s ease;
    }

    button {
      width: 100%;
      padding: 12px;
      margin: 0.5rem 0;
      font-size: 16px;
      min-height: 44px;
      transition: all 0.3s ease;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .auth-links {
      margin-top: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.8rem;
    }

    .secondary-btn {
      background: transparent !important;
      border: 1px solid var(--gold) !important;
      color: var(--gold) !important;
    }

    .secondary-btn:hover {
      background: var(--gold) !important;
      color: var(--dark-bg) !important;
    }

    /* Loading spinner styles */
    .button-loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--gold);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 0.8s linear infinite;
      display: none; /* Hidden by default */
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Mobile-specific adjustments */
    @media (max-width: 768px) {
      h1.login-header {
        font-size: 1.8rem;
        padding: 0.5rem;
      }
      
      body.mobile-view .login-container {
        padding: 1rem;
      }
      
      input {
        font-size: 16px;
        padding: 12px;
      }
    }

    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .container {
      flex: 1;
    }
  </style>
</head>
<body>
  <div class="login-page">
    <h1 class="login-header">ZA RIZQ ENTERPRISE</h1>
    
    <div class="login-container">
      <div class="input-group">
        <input type="text" 
               id="phone" 
               placeholder="Phone Number or User ID"
               pattern="^(673\d{7,}|60\d{9,}|Z\d{4})$" 
               inputmode="text"
               required>
      </div>
      
      <div class="input-group">
        <input type="password" 
               id="password" 
               placeholder="Password" 
               required>
      </div>
      <div id="loginError" class="inline-error" style="display: none;"></div>
      <button onclick="handleLogin()" id="loginBtn">
        <div class="button-loader" id="loginSpinner"></div>
        <span id="loginText">LOGIN</span>
      </button>
      
      <div class="auth-links">
        <button onclick="showRegistration()">CREATE ACCOUNT</button>
        <button class="secondary-btn" onclick="showForgotPassword()">
          FORGOT PASSWORD?
        </button>
      </div>
    </div>
  </div>

  <!-- Error message container -->
  <div id="error-message" class="error-message" style="display: none;"></div>

  <script src="scripts/app.js"></script>
  <script>
    // EXACT Mark 1 login implementation with improved spinner
    function handleLogin() {
      const btn = document.getElementById('loginBtn');
      const spinner = document.getElementById('loginSpinner');
      const loginText = document.getElementById('loginText');
      
      // Save original text and disable button
      const originalText = loginText.textContent;
      btn.disabled = true;
      
      // Show spinner and change text
      spinner.style.display = 'inline-block';
      loginText.textContent = 'Processing...';

      const identifier = document.getElementById('phone').value.trim();
      const password = document.getElementById('password').value;

      // Validate: either phone format or user ID (Z followed by 4 digits)
      const phoneRegex = /^(673\d{7,}|60\d{9,})$/;
      const userIDRegex = /^Z\d{4}$/i;
      
      if (!phoneRegex.test(identifier) && !userIDRegex.test(identifier)) {
        showError('Invalid phone number or user ID format');
        resetLoginButton(btn, spinner, loginText, originalText);
        return;
      }

      const callbackName = `jsonp_${Date.now()}`;
      const script = document.createElement('script');
      
      // EXACTLY like Mark 1 - with crossorigin attribute
      script.crossOrigin = 'anonymous';
      script.src = `${CONFIG.GAS_URL}?action=processLogin&phone=${encodeURIComponent(identifier)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;

      window[callbackName] = (response) => {
        // Restore button state
        resetLoginButton(btn, spinner, loginText, originalText);

        if (response.success) {
          console.log('TempPassword flag:', response.tempPassword);
          sessionStorage.setItem('userData', JSON.stringify({
            phone: response.phone,
            email: response.email,
            tempPassword: response.tempPassword,
            userID: response.userID   // include user ID for later use
          }));
          localStorage.setItem('lastActivity', Date.now());
          
          window.location.href = response.tempPassword 
            ? 'password-reset.html?force=true'
            : 'dashboard.html?fresh=1';
        } else {
          document.getElementById('password').value = '';
          showError(response.message || 'Authentication failed');
        }
        
        // Cleanup - EXACTLY like Mark 1
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
      };
      
      // Add error handler
      script.onerror = function() {
        resetLoginButton(btn, spinner, loginText, originalText);
        showError('Network error. Please try again.');
        if (script.parentNode) {
          document.body.removeChild(script);
        }
        delete window[callbackName];
      };
      
      document.body.appendChild(script);
    }

    // Helper function to reset login button state
    function resetLoginButton(btn, spinner, textElement, originalText) {
      btn.disabled = false;
      spinner.style.display = 'none';
      textElement.textContent = originalText;
    }

    // ======== EXACT Mark 1 ENTER KEY HANDLING ========
    document.getElementById('password').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    document.getElementById('phone').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.getElementById('password').focus();
      }
    });
    
    // ======== NEW: Auto-capitalize user ID ========
    document.getElementById('phone').addEventListener('input', function(e) {
      // Convert to uppercase as the user types (helps with user ID)
      this.value = this.value.toUpperCase();
    });
    
    function showRegistration() {
      safeRedirect('register.html');
    }

    function showForgotPassword() {
      safeRedirect('forgot-password.html');
    }

    // EXACT Mark 1 validation function (updated to accept user ID)
    function validatePhone(phone) {
      const phoneRegex = /^(673\d{7,}|60\d{9,})$/;
      const userIDRegex = /^Z\d{4}$/i;
      return phoneRegex.test(phone) || userIDRegex.test(phone);
    }

    // EXACT Mark 1 error display
    function showError(message) {
      const errorDiv = document.getElementById('error-message');
      if (errorDiv) {
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
        setTimeout(() => {
          errorDiv.style.display = 'none';
        }, 5000);
      }
    }

    // EXACT Mark 1 redirect function
    function safeRedirect(path) {
      try {
        // Extract base path without query parameters
        const basePath = path.split('?')[0].split('#')[0];
        
        const allowedPaths = [
          'login.html', 'register.html', 'dashboard.html',
          'forgot-password.html', 'password-reset.html',
          'my-info.html', 'parcel-declaration.html', 'track-parcel.html',
          'billing-info.html', 'invoice.html'
        ];
        
        if (!allowedPaths.includes(basePath)) {
          throw new Error('Unauthorized path');
        }
        
        window.location.href = path;
      } catch (error) {
        console.error('Redirect error:', error);
        showError('Navigation failed. Please try again.');
      }
    }
  </script>
</body>
</html>
