<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="format-detection" content="telephone=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Parcel Declaration - ZA RIZQI Enterprise</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    /* Safari-specific fixes */
    .safari-fix input[type="file"] {
      -webkit-appearance: none;
      appearance: none;
      border-radius: 5px;
      padding: 8px;
      background: #2a2a2a;
      color: white;
    }
    
    .safari-fix input:focus,
    .safari-fix select:focus,
    .safari-fix textarea:focus {
      outline: 2px solid var(--gold);
      outline-offset: 2px;
      -webkit-tap-highlight-color: transparent;
    }
    
    .safari-fix button {
      -webkit-appearance: none;
      appearance: none;
      -webkit-tap-highlight-color: rgba(212, 175, 55, 0.3);
    }
    
    /* Prevent iOS zoom on input focus */
    @media screen and (max-width: 768px) {
      input[type="text"],
      input[type="tel"],
      input[type="number"],
      input[type="email"],
      select,
      textarea {
        font-size: 16px !important;
      }
    }
    
    /* Safari loading animation fix */
    @keyframes safari-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .loading-spinner {
      animation: safari-spin 1s linear infinite;
    }
    
    /* Required field indicator */
    .required::after {
      content: " *";
      color: #ff4444;
    }
    
    /* Form validation styles */
    .input-group.error input,
    .input-group.error select,
    .input-group.error textarea {
      border-color: #ff4444;
      background: #3a1a1a;
    }
    
    .input-group.success input,
    .input-group.success select,
    .input-group.success textarea {
      border-color: #00C851;
      background: #1a3a1a;
    }
    
    .error-message {
      color: #ff4444;
      font-size: 0.9em;
      margin-top: 5px;
      display: block;
    }
    
    .success-message {
      color: #00C851;
      font-size: 0.9em;
      margin-top: 5px;
      display: block;
    }

    /* Global spinner overlay */
    #globalSpinnerOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.85);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      flex-direction: column;
      gap: 1rem;
    }

    .global-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(212, 175, 55, 0.3);
      border-top: 4px solid var(--gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .global-loading-text {
      color: var(--gold);
      font-size: 1.2rem;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Page header */
    .page-header {
      text-align: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--gold);
    }

    .page-header h1 {
      color: var(--gold);
      margin-bottom: 0.5rem;
    }

    .page-header .subtitle {
      color: #aaa;
      font-size: 1rem;
    }

    /* ========== CLEAN VALIDATION STYLES ========== */
    .validation-message {
      color: #ff4444 !important;
      font-size: 0.85em !important;
      margin-top: 8px !important;
      min-height: 20px;
      display: block;
      font-weight: 500;
      transition: opacity 0.3s ease;
      position: relative;
      z-index: 1000;
      background-color: transparent !important;
      padding: 2px 0 !important;
      border-radius: 0 !important;
      border-left: none !important;
      box-shadow: none !important;
      border: none !important;
    }
    
    .validation-message.success {
      color: #00C851 !important;
    }
    
    .validation-message.warning {
      color: #ffbb33 !important;
    }
    
    .input-group.invalid input,
    .input-group.invalid select,
    .input-group.invalid textarea {
      border-color: #ff4444 !important;
      background-color: rgba(255, 68, 68, 0.05) !important;
      color: #fff !important;
    }
    
    .input-group.valid input,
    .input-group.valid select,
    .input-group.valid textarea {
      border-color: #00C851 !important;
      background-color: rgba(0, 200, 81, 0.05) !important;
    }
    
    /* Clean form help text - NO grey boxes or borders */
    .form-help {
      color: #888 !important;
      font-size: 0.85em !important;
      margin-top: 5px !important;
      display: block !important;
      background: transparent !important;
      border: none !important;
      padding: 0 !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    
    /* Remove all special styling for dropdown error messages */
    #collectionPointError,
    #itemCategoryError {
      position: relative !important;
      z-index: 1000 !important;
      background-color: transparent !important;
      padding: 2px 0 !important;
      border-radius: 0 !important;
      margin-top: 5px !important;
      display: block !important;
      color: #ff4444 !important;
      font-weight: 500 !important;
      border: none !important;
      box-shadow: none !important;
    }
    
    /* Submit button states */
    #submitBtn:disabled {
      background: #555 !important;
      cursor: not-allowed !important;
      opacity: 0.7 !important;
    }
    
    #submitBtn:enabled {
      background: linear-gradient(135deg, #d4af37, #b8941f) !important;
      cursor: pointer !important;
      opacity: 1 !important;
    }

    /* Network Status Indicator */
    #networkStatus {
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
      display: none;
    }

    .status-icon {
      margin-right: 8px;
    }

    /* Drafts Section */
    .drafts-section {
      margin-top: 30px;
      border-top: 1px solid #444;
      padding-top: 20px;
    }

    .drafts-toggle {
      background: #2a2a2a;
      border: 1px solid #444;
      color: var(--gold);
      padding: 10px 15px;
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      text-align: left;
      font-size: 1rem;
    }

    .drafts-list {
      margin-top: 15px;
      padding: 15px;
      background: rgba(42, 42, 42, 0.5);
      border-radius: 5px;
    }

    .draft-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #444;
    }

    .draft-item:last-child {
      border-bottom: none;
    }

    .draft-info {
      flex: 1;
    }

    .draft-actions {
      display: flex;
      gap: 10px;
    }

    .small-btn {
      padding: 5px 10px;
      font-size: 0.85rem;
      background: #444;
      border: none;
      color: white;
      border-radius: 3px;
      cursor: pointer;
    }

    .small-btn.delete {
      background: #ff4444;
    }

    .empty-drafts {
      color: #888;
      text-align: center;
      padding: 20px;
    }
  </style>
</head>
<body class="safari-fix">
  <!-- Global Spinner Overlay -->
  <div id="globalSpinnerOverlay">
    <div class="global-spinner"></div>
    <div class="global-loading-text">Processing Submission...</div>
  </div>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <h1>üì¶ Parcel Declaration</h1>
      <p class="subtitle">Submit your parcel information for customs declaration</p>
    </div>

    <!-- Network Status Indicator -->
    <div id="networkStatus" class="network-status" style="display: none;">
      <span class="status-icon">üî¥</span>
      <span class="status-text">Offline - Form will be saved locally</span>
    </div>

    <!-- Success/Error Messages -->
    <div id="statusMessage" class="message" style="display: none;"></div>
    <div id="errorMessage" class="error-message" style="display: none;"></div>

    <!-- Main Form -->
    <form id="declarationForm" novalidate>
      <!-- Tracking Number -->
      <div class="input-group">
        <label for="trackingNumber" class="required">Tracking Number:</label>
        <input 
          type="text" 
          id="trackingNumber" 
          name="trackingNumber"
          pattern="^[A-Za-z0-9\-]{5,}$"
          title="Minimum 5 characters, letters, numbers, and hyphens only"
          placeholder="e.g., ABC123456 or 123-456-789"
          required
          autocomplete="off"
          autocapitalize="characters"
        >
        <small class="form-help">Enter your tracking number exactly as provided by the carrier</small>
        <span id="trackingError" class="validation-message"></span>
      </div>

      <!-- Name on Parcel -->
      <div class="input-group">
        <label for="nameOnParcel" class="required">Name on Parcel:</label>
        <input 
          type="text" 
          id="nameOnParcel" 
          name="nameOnParcel"
          minlength="2"
          maxlength="100"
          placeholder="Enter the exact name as on the parcel"
          required
          autocomplete="name"
        >
        <span id="nameOnParcelError" class="validation-message"></span>
      </div>

      <!-- Auto-populated Phone Number -->
      <div class="input-group">
        <label for="phone" class="required">Phone Number:</label>
        <input 
          type="tel" 
          id="phone" 
          name="phone"
          pattern="^(673\d{7,}|60\d{9,})$"
          title="Brunei: 673XXXXXXX or Malaysia: 60XXXXXXXXX"
          required
          readonly
          style="background-color: #333; color: #888;"
        >
        <small class="form-help">This is your registered phone number</small>
      </div>

      <!-- Item Description -->
      <div class="input-group">
        <label for="itemDescription" class="required">Item Description:</label>
        <textarea 
          id="itemDescription" 
          name="itemDescription"
          rows="3"
          minlength="3"
          maxlength="500"
          placeholder="Simple item detail. For multiple items example:
- Baju x2 RM30
- Seluar x1 RM10"
          required
        ></textarea>
        <small class="form-help">Be specific for customs clearance</small>
        <span id="itemDescriptionError" class="validation-message"></span>
      </div>

      <!-- Quantity and Price -->
      <div class="input-group double-column">
        <div>
          <label for="quantity" class="required">Quantity:</label>
          <input 
            type="number" 
            id="quantity" 
            name="quantity"
            min="1"
            max="999"
            step="1"
            placeholder="Total parcel quantity"
            required
          >
          <span id="quantityError" class="validation-message"></span>
        </div>
        <div>
          <label for="price" class="required">Price (MYR):</label>
          <input 
            type="number" 
            id="price" 
            name="price"
            min="0"
            max="99999"
            step="0.01"
            placeholder="0.00"
            required
          >
          <small class="form-help">Value in Malaysian Ringgit</small>
          <span id="priceError" class="validation-message"></span>
        </div>
      </div>

      <!-- Collection Point -->
      <div class="input-group">
        <label for="collectionPoint" class="required">Collection Point:</label>
        <select id="collectionPoint" name="collectionPoint" required>
          <option value="">-- Select Collection Point --</option>
          <option value="Rimba">Rimba</option>
          <option value="Bengkurong">Bengkurong</option>
        </select>
        <span id="collectionPointError" class="validation-message"></span>
      </div>

      <!-- ========== UPDATED ITEM CATEGORY (NEW LIST) ========== -->
      <div class="input-group">
        <label for="itemCategory" class="required">Item Category:</label>
        <select id="itemCategory" name="itemCategory" required>
          <option value="">-- Select Category --</option>
          <option value="Apparels">Apparels</option>
          <option value="Bags">Bags</option>
          <option value="Car Parts/Accessories">Car Parts/Accessories</option>
          <option value="Cosmetics">Cosmetics</option>
          <option value="Electrical Goods">Electrical Goods</option>
          <option value="Footwear">Footwear</option>
          <option value="Food">Food</option>
          <option value="Furniture">Furniture</option>
          <option value="Gadgets">Gadgets</option>
          <option value="Kitchenware">Kitchenware</option>
          <option value="Plastics">Plastics</option>
          <option value="Stationery">Stationery</option>
          <option value="Supplement">Supplement</option>
          <option value="Others">Others</option>
        </select>
        <small class="form-help">File upload is required for all categories</small>
        <span id="itemCategoryError" class="validation-message"></span>
      </div>

      <!-- File Upload Section -->
      <div class="input-group file-upload-section">
        <label for="fileUpload">Upload Documents:</label>
        <input 
          type="file" 
          id="fileUpload" 
          name="files"
          multiple
          accept="image/*,.pdf"
          style="display: block; width: 100%; padding: 12px; margin-top: 5px;"
        >
        <small id="fileHelp" class="form-text">
          <span id="fileRequirement">Required: </span>JPEG, PNG, PDF (Max 5MB each)
        </small>
        
        <span id="invoiceFilesError" class="validation-message" style="color: #ff4444;">Required: At least 1 invoice/document required</span>
      </div>

      <!-- Form Buttons -->
      <div class="button-group">
        <button 
          type="submit" 
          id="submitBtn" 
          class="gold-button"
          disabled
        >
          <span id="submitText">Please fix errors above</span>
          <span id="submitSpinner" style="display: none;">‚è≥ Processing...</span>
        </button>
        
        <button 
          type="button" 
          class="secondary-button"
          onclick="safeRedirect('dashboard.html')"
        >
          ‚Üê Back to Dashboard
        </button>
        
        <button 
          type="button" 
          class="secondary-button"
          onclick="saveDraft()"
          id="saveDraftBtn"
        >
          üíæ Save as Draft
        </button>
      </div>
    </form>

    <!-- Info Box -->
    <div class="info-box">
      <h3>üìã Important Notes:</h3>
      <ul>
        <li>Ensure tracking number matches your shipment exactly</li>
        <li>File upload is now mandatory for all categories</li>
        <li>You can save as draft and return later</li>
        <li>Submit once per parcel/shipment</li>
      </ul>
    </div>

    <!-- Drafts Section (Collapsible) -->
    <div class="drafts-section">
      <button onclick="toggleDrafts()" class="drafts-toggle">
        üìÅ Saved Drafts (<span id="draftCount">0</span>)
      </button>
      <div id="draftsList" class="drafts-list" style="display: none;"></div>
    </div>
  </div>

<!-- Safari-specific script initialization -->
<script>
  // Detect Safari browser
  function isSafari() {
    const ua = navigator.userAgent;
    const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
    const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
    return isSafari || isIOS;
  }

  // Apply Safari-specific fixes
  if (isSafari()) {
    console.log('Safari browser detected - applying compatibility fixes');
    
    // Add Safari class to body
    document.body.classList.add('safari-browser');
    
    // Disable autocorrect for form fields
    document.querySelectorAll('input[type="text"], textarea').forEach(el => {
      el.setAttribute('autocorrect', 'off');
      el.setAttribute('spellcheck', 'false');
    });
    
    // Fix for file input styling
    const fileInput = document.getElementById('fileUpload');
    if (fileInput) {
      fileInput.style.opacity = '1';
      fileInput.style.position = 'relative';
      fileInput.style.zIndex = '1';
    }
  }

  // Network detection
  function updateNetworkStatus() {
    const statusEl = document.getElementById('networkStatus');
    if (!statusEl) return;
    
    if (navigator.onLine) {
      statusEl.style.display = 'none';
    } else {
      statusEl.style.display = 'block';
      statusEl.querySelector('.status-icon').textContent = 'üî¥';
      statusEl.querySelector('.status-text').textContent = 'Offline - Form will be saved locally';
    }
  }

  // Initialize network status
  window.addEventListener('online', updateNetworkStatus);
  window.addEventListener('offline', updateNetworkStatus);
  updateNetworkStatus();
</script>

<script src="scripts/app.js"></script>
<script>
  // ========== UPDATED REAL-TIME VALIDATION SYSTEM ==========
  // (All starred‚Äëcategory logic removed; files are mandatory when a category is selected)
  
  function initRealTimeValidation() {
    console.log('Initializing real-time validation...');
    
    setTimeout(() => {
      console.log('Running initial page load validation...');
      runInitialValidation();
      setupRealTimeValidationListeners();
    }, 100);
  }

  function runInitialValidation() {
    console.log('Running initial validation for all fields...');
    
    const fieldsToValidate = [
      { id: 'trackingNumber', name: 'Tracking Number', type: 'tracking' },
      { id: 'nameOnParcel', name: 'Name on Parcel', type: 'name' },
      { id: 'itemDescription', name: 'Item Description', type: 'description' },
      { id: 'quantity', name: 'Quantity', type: 'quantity' },
      { id: 'price', name: 'Price', type: 'price' },
      { id: 'collectionPoint', name: 'Collection Point', type: 'select' },
      { id: 'itemCategory', name: 'Item Category', type: 'select' }
    ];
    
    fieldsToValidate.forEach(field => {
      const fieldElement = document.getElementById(field.id);
      const errorElement = document.getElementById(field.id + 'Error') || 
                          createErrorMessageElement(field.id);
      
      if (!fieldElement) return;
      
      let isValid = false;
      let message = '';
      
      switch(field.type) {
        case 'tracking':
          isValid = validateTrackingNumberOnLoad(fieldElement.value);
          message = isValid ? '' : 'Minimum 5 alphanumeric characters or hyphens';
          break;
        case 'name':
          isValid = validateNameOnLoad(fieldElement.value);
          message = isValid ? '' : 'Minimum 2 characters required';
          break;
        case 'description':
          isValid = validateDescriptionOnLoad(fieldElement.value);
          message = isValid ? '' : 'Minimum 3 characters required';
          break;
        case 'quantity':
          isValid = validateQuantityOnLoad(fieldElement.value);
          message = isValid ? '' : 'Must be between 1 and 999';
          break;
        case 'price':
          isValid = validatePriceOnLoad(fieldElement.value);
          message = isValid ? '' : 'Price must be 0 or greater (0 is allowed)';
          break;
        case 'select':
          isValid = validateSelectOnLoad(fieldElement.value);
          message = isValid ? '' : 'Please select an option';
          break;
      }
      
      updateFieldValidationState(fieldElement, isValid, message);
    });
    
    // Validate files if a category is selected (mandatory)
    const category = document.getElementById('itemCategory')?.value || '';
    if (category) {
      const files = document.getElementById('fileUpload')?.files || [];
      if (files.length === 0) {
        const fileInput = document.getElementById('fileUpload');
        const fileError = document.getElementById('invoiceFilesError');
        
        if (fileInput && fileError) {
          fileError.textContent = 'Required: At least 1 invoice/document required';
          fileError.style.color = '#ff4444';
          fileError.style.display = 'block';
          fileInput.style.borderColor = '#ff4444';
          fileInput.parentElement.classList.add('invalid');
        }
      }
    }
    
    updateSubmitButton();
    return true;
  }

  function validateTrackingNumberOnLoad(value) {
    return value && /^[A-Za-z0-9\-]{5,}$/.test(value.trim());
  }

  function validateNameOnLoad(value) {
    return value && value.trim().length >= 2;
  }

  function validateDescriptionOnLoad(value) {
    return value && value.trim().length >= 3;
  }

  function validateQuantityOnLoad(value) {
    const num = parseInt(value);
    return !isNaN(num) && num >= 1 && num <= 999;
  }

  function validatePriceOnLoad(value) {
    if (value === '') return false;
    const num = parseFloat(value);
    return !isNaN(num) && num >= 0;
  }

  function validateSelectOnLoad(value) {
    return value && value !== '';
  }

  function createErrorMessageElement(fieldId) {
    const errorSpan = document.createElement('span');
    errorSpan.id = fieldId + 'Error';
    errorSpan.className = 'validation-message';
    
    const fieldElement = document.getElementById(fieldId);
    const parent = fieldElement?.parentElement;
    if (fieldElement && parent) {
      parent.appendChild(errorSpan);
    }
    
    return errorSpan;
  }

  function updateFieldValidationState(fieldElement, isValid, message) {
    const errorElement = document.getElementById(fieldElement.id + 'Error');
    const parent = fieldElement.parentElement;
    
    parent.classList.remove('valid', 'invalid');
    
    if (isValid) {
      parent.classList.add('valid');
      if (errorElement) {
        errorElement.textContent = '';
        errorElement.style.display = 'none';
        fieldElement.style.borderColor = '#444';
      }
    } else {
      parent.classList.add('invalid');
      if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.color = '#ff4444';
        errorElement.style.display = 'block';
        fieldElement.style.borderColor = '#ff4444';
      }
    }
    
    if (errorElement) {
      errorElement.style.backgroundColor = 'transparent';
      errorElement.style.border = 'none';
      errorElement.style.boxShadow = 'none';
      errorElement.style.padding = '2px 0';
    }
  }

  function setupRealTimeValidationListeners() {
    console.log('Setting up real-time validation listeners...');
    
    const fields = [
      'trackingNumber',
      'nameOnParcel', 
      'itemDescription',
      'quantity',
      'price',
      'collectionPoint',
      'itemCategory'
    ];
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', () => validateFieldInRealTime(field));
        field.addEventListener('change', () => validateFieldInRealTime(field));
        
        if (field.tagName === 'SELECT') {
          field.addEventListener('change', () => {
            validateFieldInRealTime(field);
            checkCategoryRequirements();
          });
        }
      }
    });
    
    const fileUpload = document.getElementById('fileUpload');
    if (fileUpload) {
      fileUpload.addEventListener('change', validateFilesInRealTime);
    }
  }

  function validateFieldInRealTime(field) {
    const value = field.value;
    let isValid = false;
    let message = '';
    
    switch(field.id) {
      case 'trackingNumber':
        isValid = validateTrackingNumberOnLoad(value);
        message = isValid ? '' : 'Minimum 5 alphanumeric characters or hyphens';
        break;
      case 'nameOnParcel':
        isValid = validateNameOnLoad(value);
        message = isValid ? '' : 'Minimum 2 characters required';
        break;
      case 'itemDescription':
        isValid = validateDescriptionOnLoad(value);
        message = isValid ? '' : 'Minimum 3 characters required';
        break;
      case 'quantity':
        isValid = validateQuantityOnLoad(value);
        message = isValid ? '' : 'Must be between 1 and 999';
        break;
      case 'price':
        isValid = validatePriceOnLoad(value);
        message = isValid ? '' : 'Price must be 0 or greater (0 is allowed)';
        break;
      case 'collectionPoint':
      case 'itemCategory':
        isValid = validateSelectOnLoad(value);
        message = isValid ? '' : 'Please select an option';
        break;
    }
    
    updateFieldValidationState(field, isValid, message);
    updateSubmitButton();
    
    if (field.id === 'itemCategory') {
      setTimeout(() => {
        checkCategoryRequirements();
      }, 100);
    }
  }

  // ===== UPDATED FILE VALIDATION ‚Äì MANDATORY WHEN CATEGORY SELECTED =====
  function validateFilesInRealTime() {
    const fileInput = document.getElementById('fileUpload');
    const category = document.getElementById('itemCategory')?.value || '';
    
    if (!fileInput) return;
    
    const errorElement = document.getElementById('invoiceFilesError');
    const parent = fileInput.parentElement;
    
    parent.classList.remove('valid', 'invalid');

    if (!category) {
      errorElement.textContent = 'Select a category to enable file upload';
      errorElement.style.color = '#888';
      parent.classList.remove('invalid');
      fileInput.style.borderColor = '#444';
      updateSubmitButton();
      return;
    }

    const files = fileInput.files;
    
    if (files.length === 0) {
      errorElement.textContent = 'Required: At least 1 invoice/document required';
      errorElement.style.color = '#ff4444';
      errorElement.style.display = 'block';
      parent.classList.add('invalid');
      fileInput.style.borderColor = '#ff4444';
    } else {
      let allValid = true;
      const MAX_SIZE = 5 * 1024 * 1024;
      const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (!allowedTypes.includes(file.type)) {
          errorElement.textContent = `File "${file.name}" must be JPG, PNG, or PDF`;
          allValid = false;
          break;
        }
        if (file.size > MAX_SIZE) {
          errorElement.textContent = `File "${file.name}" exceeds 5MB limit`;
          allValid = false;
          break;
        }
      }
      
      if (allValid) {
        errorElement.textContent = `${files.length} file(s) selected`;
        errorElement.style.color = '#00C851';
        parent.classList.add('valid');
        fileInput.style.borderColor = '#00C851';
      } else {
        errorElement.style.color = '#ff4444';
        parent.classList.add('invalid');
        fileInput.style.borderColor = '#ff4444';
      }
    }
    
    updateSubmitButton();
  }

  // ===== UPDATED CATEGORY REQUIREMENTS ‚Äì ALWAYS REQUIRES FILES =====
  function checkCategoryRequirements() {
    const category = document.getElementById('itemCategory')?.value || '';
    const fileInput = document.getElementById('fileUpload');
    const fileHelp = document.getElementById('fileHelp');
    const fileRequirement = document.getElementById('fileRequirement');
    
    if (!fileInput || !fileHelp) return;

    if (category) {
      fileInput.required = true;
      if (fileRequirement) {
        fileRequirement.textContent = 'Required: ';
        fileRequirement.style.color = '#ff4444';
      }
      fileHelp.innerHTML = 'Required: JPEG, PNG, PDF (Max 5MB each)';
      fileHelp.style.color = '#ff4444';
      fileHelp.style.fontWeight = 'bold';
    } else {
      fileInput.required = false;
      if (fileRequirement) {
        fileRequirement.textContent = '';
      }
      fileHelp.innerHTML = 'Select a category to enable file upload';
      fileHelp.style.color = '#888';
      fileHelp.style.fontWeight = 'normal';
    }

    setTimeout(() => {
      validateFilesInRealTime();
      updateSubmitButton();
    }, 100);
  }

  // ===== UPDATED SUBMIT BUTTON ‚Äì CHECK FILES IF CATEGORY SELECTED =====
  function updateSubmitButton() {
    const submitBtn = document.getElementById('submitBtn');
    if (!submitBtn) return;
    
    const fields = [
      'trackingNumber',
      'nameOnParcel',
      'itemDescription',
      'quantity',
      'price',
      'collectionPoint',
      'itemCategory'
    ];
    
    let allValid = true;
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      const parent = field?.parentElement;
      
      if (!field) {
        allValid = false;
        return;
      }
      
      if (parent && parent.classList.contains('invalid')) {
        allValid = false;
        return;
      }
      
      if (field.tagName === 'SELECT') {
        if (!field.value) allValid = false;
      } else if (field.type === 'number') {
        if (field.value === '') allValid = false;
      } else {
        if (!field.value.trim()) allValid = false;
      }
    });
    
    const category = document.getElementById('itemCategory')?.value || '';
    if (category) {
      const files = document.getElementById('fileUpload')?.files || [];
      const fileParent = document.getElementById('fileUpload')?.parentElement;
      
      if (files.length === 0 || (fileParent && fileParent.classList.contains('invalid'))) {
        allValid = false;
      }
    } else {
      allValid = false;
    }
    
    submitBtn.disabled = !allValid;
    
    const submitText = document.getElementById('submitText');
    if (submitText) {
      submitText.textContent = allValid ? 'Submit Declaration' : 'Please fix errors above';
    }
    
    if (allValid) {
      submitBtn.style.background = 'linear-gradient(135deg, #d4af37, #b8941f)';
      submitBtn.style.cursor = 'pointer';
      submitBtn.style.opacity = '1';
    } else {
      submitBtn.style.background = '#555';
      submitBtn.style.cursor = 'not-allowed';
      submitBtn.style.opacity = '0.7';
    }
  }

  // ========== FORM-SPECIFIC FUNCTIONS ==========
  document.addEventListener('DOMContentLoaded', function() {
    const userData = JSON.parse(sessionStorage.getItem('userData') || '{}');
    if (userData.phone) {
      document.getElementById('userPhone').textContent = userData.phone;
      document.getElementById('phone').value = userData.phone;
    } else {
      window.location.href = 'login.html';
      return;
    }

    loadDrafts();
    const fileInput = document.getElementById('fileUpload');
    if (fileInput) {
      fileInput.addEventListener('change', handleFileSelection);
    }

    initRealTimeValidation();
    setupFieldValidations();
    checkCategoryRequirements();
  });

  function setupFieldValidations() {
    const fields = [
      'trackingNumber',
      'nameOnParcel',
      'itemDescription',
      'quantity',
      'price',
      'collectionPoint',
      'itemCategory'
    ];
    
    fields.forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        const newField = field.cloneNode(true);
        field.parentNode.replaceChild(newField, field);
        
        newField.addEventListener('input', () => {
          if (typeof validateFieldInRealTime === 'function') {
            validateFieldInRealTime(newField);
          }
        });
        newField.addEventListener('change', () => {
          if (typeof validateFieldInRealTime === 'function') {
            validateFieldInRealTime(newField);
          }
        });
      }
    });
  }

  function handleFileSelection(event) {
    const fileInput = event.target;
    const files = fileInput.files;
    const errorEl = document.getElementById('invoiceFilesError');
    
    if (errorEl) errorEl.textContent = '';
    
    if (files.length === 0) {
      updateSubmitButton();
      return;
    }
    
    const MAX_SIZE = 5 * 1024 * 1024;
    let hasError = false;
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i];
      const allowedTypes = ['image/jpeg', 'image/png', 'application/pdf'];
      
      if (!allowedTypes.includes(file.type)) {
        errorEl.textContent = `File "${file.name}" must be JPG, PNG, or PDF`;
        hasError = true;
        break;
      }
      
      if (file.size > MAX_SIZE) {
        errorEl.textContent = `File "${file.name}" exceeds 5MB limit`;
        hasError = true;
        break;
      }
    }
    
    if (hasError) {
      fileInput.value = '';
    }
    
    updateSubmitButton();
  }

  function saveDraft() {
    const form = document.getElementById('declarationForm');
    const formData = new FormData(form);
    const draft = {};
    
    for (let [key, value] of formData.entries()) {
      if (key !== 'files') {
        draft[key] = value;
      }
    }
    
    const files = document.getElementById('fileUpload')?.files || [];
    if (files.length > 0) {
      draft.filesCount = files.length;
      draft.filesInfo = Array.from(files).map(file => ({
        name: file.name,
        size: file.size,
        type: file.type
      }));
    }
    
    draft.timestamp = new Date().toISOString();
    draft.id = 'draft_' + Date.now();
    
    const drafts = JSON.parse(localStorage.getItem('parcelDrafts') || '[]');
    drafts.push(draft);
    localStorage.setItem('parcelDrafts', JSON.stringify(drafts));
    
    showMessage('Draft saved successfully!', 'success');
    loadDrafts();
  }

  function loadDrafts() {
    const drafts = JSON.parse(localStorage.getItem('parcelDrafts') || '[]');
    const draftCount = document.getElementById('draftCount');
    const draftsList = document.getElementById('draftsList');
    
    if (draftCount) draftCount.textContent = drafts.length;
    
    if (draftsList) {
      if (drafts.length === 0) {
        draftsList.innerHTML = '<p class="empty-drafts">No saved drafts</p>';
        return;
      }
      
      let html = '<div class="drafts-container">';
      drafts.forEach((draft, index) => {
        html += `
          <div class="draft-item">
            <div class="draft-info">
              <strong>${draft.trackingNumber || 'Untitled'}</strong>
              <small>${new Date(draft.timestamp).toLocaleDateString()}</small>
            </div>
            <div class="draft-actions">
              <button onclick="loadDraftFromList(${index})" class="small-btn">Load</button>
              <button onclick="deleteDraft(${index})" class="small-btn delete">Delete</button>
            </div>
          </div>
        `;
      });
      html += '</div>';
      draftsList.innerHTML = html;
    }
  }

  function loadDraftFromList(index) {
    const drafts = JSON.parse(localStorage.getItem('parcelDrafts') || '[]');
    const draft = drafts[index];
    
    if (!draft) return;
    
    clearAllValidationErrors();
    
    Object.keys(draft).forEach(key => {
      if (key !== 'timestamp' && key !== 'id' && key !== 'filesCount' && key !== 'filesInfo') {
        const field = document.getElementById(key);
        if (field) {
          field.value = draft[key];
          if (typeof validateFieldInRealTime === 'function') {
            validateFieldInRealTime(field);
          }
        }
      }
    });
    
    if (typeof checkCategoryRequirements === 'function') {
      checkCategoryRequirements();
    }
    
    if (typeof updateSubmitButton === 'function') {
      updateSubmitButton();
    }
    
    showMessage('Draft loaded!', 'success');
  }

  function clearAllValidationErrors() {
    const errorElements = document.querySelectorAll('.validation-message');
    errorElements.forEach(element => {
      element.textContent = '';
      element.style.display = 'none';
      element.style.color = '';
    });
    
    const fields = document.querySelectorAll('input, select, textarea');
    fields.forEach(field => {
      field.style.borderColor = '';
      field.parentElement.classList.remove('invalid', 'valid');
    });
    
    const fileError = document.getElementById('invoiceFilesError');
    if (fileError) {
      fileError.textContent = 'Required: At least 1 invoice/document required';
      fileError.style.color = '#ff4444';
      fileError.style.display = 'block';
    }
  }

  function deleteDraft(index) {
    const drafts = JSON.parse(localStorage.getItem('parcelDrafts') || '[]');
    drafts.splice(index, 1);
    localStorage.setItem('parcelDrafts', JSON.stringify(drafts));
    loadDrafts();
    showMessage('Draft deleted', 'info');
  }

  function toggleDrafts() {
    const draftsList = document.getElementById('draftsList');
    if (draftsList.style.display === 'none') {
      draftsList.style.display = 'block';
    } else {
      draftsList.style.display = 'none';
    }
  }

  function showMessage(text, type = 'info') {
    const messageEl = document.getElementById('statusMessage');
    const errorEl = document.getElementById('errorMessage');
    
    if (errorEl) {
      errorEl.style.display = 'none';
      errorEl.textContent = '';
    }
    
    if (!messageEl) return;
    
    messageEl.textContent = text;
    messageEl.className = 'message ' + type;
    messageEl.style.display = 'block';
    
    setTimeout(() => {
      messageEl.style.display = 'none';
    }, 5000);
  }

  function showError(text) {
    const messageEl = document.getElementById('statusMessage');
    const errorEl = document.getElementById('errorMessage');
    
    if (messageEl) {
      messageEl.style.display = 'none';
      messageEl.textContent = '';
    }
    
    if (!errorEl) return;
    
    errorEl.textContent = text;
    errorEl.style.display = 'block';
    
    setTimeout(() => {
      errorEl.style.display = 'none';
    }, 5000);
  }

  window.loadDrafts = loadDrafts;
  window.loadDraftFromList = loadDraftFromList;
  window.deleteDraft = deleteDraft;
  window.toggleDrafts = toggleDrafts;
  window.saveDraft = saveDraft;
  window.clearAllValidationErrors = clearAllValidationErrors;
</script>
</body>
</html>
